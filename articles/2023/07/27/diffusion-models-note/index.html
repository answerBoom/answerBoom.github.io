<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>æ‰©æ•£æ¨¡å‹ | ğŸ» liyBlog</title>
<meta name="keywords" content="æ‰©æ•£æ¨¡å‹">
<meta name="description" content="æ‰©æ•£æ¨¡å‹å­¦ä¹ ç¬”è®° æ€è·¯ è®­ç»ƒä¸ªæ•°ä¸ºTï¼ˆæ—¶åˆ»æ•°ï¼‰çš„ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚é€šè¿‡æ­£å‘æ‰©æ•£è·å¾—æ¯ä¸ªæ—¶åˆ»tçš„å‡å€¼å’Œæ–¹å·®ã€‚åˆ©ç”¨é‡å‚æ•°åŒ–æŠ€å·§ï¼Œå°†éšæœºæ€§è½¬ç§»åˆ°$\epsilon$ä¸Šï¼Œæ•´ä¸ªè¿‡ç¨‹çœ‹ä½œæ˜¯é©¬å°”å¯å¤«è¿‡ç¨‹ï¼Œæ¯ä¸ªæ—¶åˆ»çš„åˆ†å¸ƒå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ ¹æ®ä¸‹åˆ—å…¬å¼å¯ä»¥å¾—åˆ°ä»»æ„æ—¶åˆ»çš„$q(x_t|x_{t-1})$
å­¦ä¹ $p_\theta$å»è¿‘ä¼¼q()ï¼Œæ ¹æ®è´å¶æ–¯å¯ä»¥ç®—å‡ºé€†å‘è¿‡ç¨‹qçš„å‡å€¼å’Œæ–¹å·®ï¼š
ä¸Šè¿°å…¬å¼çš„å‡å€¼ä¸º$b\over -2a$ï¼Œæ–¹å·®ä¸º$1\over a$,è®¡ç®—pçš„å¯¹æ•°æŸå¤±ï¼Œä½¿å…¶æœ€å¤§ï¼Œ
ç»è¿‡ç®€åŒ–åçš„å¯¹æ•°æŸå¤±ï¼Œä¸”å› ä¸ºæ–¹å·®æ˜¯å¸¸æ•°ï¼Œå¯ä¼˜åŒ–çš„åªæœ‰å‡å€¼ï¼š æœ€åã€‚å­¦ä¹ ä¸€ä¸ª$\epsilon_\theta$å»é€¼è¿‘$\epsilon_t$
é‡å‚æ•°åŒ–æŠ€å·§ åœ¨é«˜æ–¯åˆ†å¸ƒ$\aleph(\mu,sigma^2)$ä¸­é‡‡æ ·æ˜¯ä¸€ä¸ªéšæœºè¿‡ç¨‹ï¼Œä¸èƒ½è¿›è¡Œåå‘ä¼ æ’­æ¢¯åº¦ï¼Œå¯ä»¥å…ˆä»æ ‡å‡†åˆ†å¸ƒ$\aleph(0ï¼Œ1)$ä¸­é‡‡æ ·ï¼Œå¾—åˆ°$\sigma*\epsilon&#43;\mu$å°†éšæœºæ€§è½¬ç§»åˆ°è¿™ä¸ª$\epsilon$å¸¸é‡ä¸Š
1.å¯¼å…¥æ•°æ® %matplotlib inline import matplotlib.pyplot as plt import numpy as np from sklearn.datasets import make_s_curve import torch s_curve,_ = make_s_curve(10**4,noise=0.1) s_curve = s_curve[:,[0,2]]/10.0 print(&#34;shape of s:&#34;,np.shape(s_curve)) #æ ·æœ¬ç»´åº¦è½¬åŒ–ä¸ºç‰¹å¾ç»´åº¦ data = s_curve.T fig,ax = plt.subplots() ax.scatter(*data,color=&#39;blue&#39;,edgecolor=&#39;white&#39;); ax.axis(&#39;off&#39;) dataset = torch.Tensor(s_curve).float() 2. ç¡®å®šè¶…å‚æ•°çš„å€¼ num_steps = 100 #åˆ¶å®šæ¯ä¸€æ­¥çš„beta betas = torch.linspace(-6,6,num_steps) betas = torch.sigmoid(betas)*(0.5e-2 - 1e-5)&#43;1e-5 #è®¡ç®—alphaã€alpha_prodã€alpha_prod_previousã€alpha_bar_sqrtç­‰å˜é‡çš„å€¼ alphas = 1-betas alphas_prod = torch.cumprod(alphas,0) alphas_prod_p = torch.">
<meta name="author" content="">
<link rel="canonical" href="answerboom.github.io/articles/2023/07/27/diffusion-models-note/">
<link crossorigin="anonymous" href="/answerboom.github.io/assets/css/stylesheet.f1ce240cfe5af969a7d47c7624c2a49eda79c4e4fd31a81b2d14d80a5fbc3546.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/answerboom.github.io/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="answerboom.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="answerboom.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="answerboom.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="answerboom.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="answerboom.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="æ‰©æ•£æ¨¡å‹" />
<meta property="og:description" content="æ‰©æ•£æ¨¡å‹å­¦ä¹ ç¬”è®° æ€è·¯ è®­ç»ƒä¸ªæ•°ä¸ºTï¼ˆæ—¶åˆ»æ•°ï¼‰çš„ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚é€šè¿‡æ­£å‘æ‰©æ•£è·å¾—æ¯ä¸ªæ—¶åˆ»tçš„å‡å€¼å’Œæ–¹å·®ã€‚åˆ©ç”¨é‡å‚æ•°åŒ–æŠ€å·§ï¼Œå°†éšæœºæ€§è½¬ç§»åˆ°$\epsilon$ä¸Šï¼Œæ•´ä¸ªè¿‡ç¨‹çœ‹ä½œæ˜¯é©¬å°”å¯å¤«è¿‡ç¨‹ï¼Œæ¯ä¸ªæ—¶åˆ»çš„åˆ†å¸ƒå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ ¹æ®ä¸‹åˆ—å…¬å¼å¯ä»¥å¾—åˆ°ä»»æ„æ—¶åˆ»çš„$q(x_t|x_{t-1})$
å­¦ä¹ $p_\theta$å»è¿‘ä¼¼q()ï¼Œæ ¹æ®è´å¶æ–¯å¯ä»¥ç®—å‡ºé€†å‘è¿‡ç¨‹qçš„å‡å€¼å’Œæ–¹å·®ï¼š
ä¸Šè¿°å…¬å¼çš„å‡å€¼ä¸º$b\over -2a$ï¼Œæ–¹å·®ä¸º$1\over a$,è®¡ç®—pçš„å¯¹æ•°æŸå¤±ï¼Œä½¿å…¶æœ€å¤§ï¼Œ
ç»è¿‡ç®€åŒ–åçš„å¯¹æ•°æŸå¤±ï¼Œä¸”å› ä¸ºæ–¹å·®æ˜¯å¸¸æ•°ï¼Œå¯ä¼˜åŒ–çš„åªæœ‰å‡å€¼ï¼š æœ€åã€‚å­¦ä¹ ä¸€ä¸ª$\epsilon_\theta$å»é€¼è¿‘$\epsilon_t$
é‡å‚æ•°åŒ–æŠ€å·§ åœ¨é«˜æ–¯åˆ†å¸ƒ$\aleph(\mu,sigma^2)$ä¸­é‡‡æ ·æ˜¯ä¸€ä¸ªéšæœºè¿‡ç¨‹ï¼Œä¸èƒ½è¿›è¡Œåå‘ä¼ æ’­æ¢¯åº¦ï¼Œå¯ä»¥å…ˆä»æ ‡å‡†åˆ†å¸ƒ$\aleph(0ï¼Œ1)$ä¸­é‡‡æ ·ï¼Œå¾—åˆ°$\sigma*\epsilon&#43;\mu$å°†éšæœºæ€§è½¬ç§»åˆ°è¿™ä¸ª$\epsilon$å¸¸é‡ä¸Š
1.å¯¼å…¥æ•°æ® %matplotlib inline import matplotlib.pyplot as plt import numpy as np from sklearn.datasets import make_s_curve import torch s_curve,_ = make_s_curve(10**4,noise=0.1) s_curve = s_curve[:,[0,2]]/10.0 print(&#34;shape of s:&#34;,np.shape(s_curve)) #æ ·æœ¬ç»´åº¦è½¬åŒ–ä¸ºç‰¹å¾ç»´åº¦ data = s_curve.T fig,ax = plt.subplots() ax.scatter(*data,color=&#39;blue&#39;,edgecolor=&#39;white&#39;); ax.axis(&#39;off&#39;) dataset = torch.Tensor(s_curve).float() 2. ç¡®å®šè¶…å‚æ•°çš„å€¼ num_steps = 100 #åˆ¶å®šæ¯ä¸€æ­¥çš„beta betas = torch.linspace(-6,6,num_steps) betas = torch.sigmoid(betas)*(0.5e-2 - 1e-5)&#43;1e-5 #è®¡ç®—alphaã€alpha_prodã€alpha_prod_previousã€alpha_bar_sqrtç­‰å˜é‡çš„å€¼ alphas = 1-betas alphas_prod = torch.cumprod(alphas,0) alphas_prod_p = torch." />
<meta property="og:type" content="article" />
<meta property="og:url" content="answerboom.github.io/articles/2023/07/27/diffusion-models-note/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-27T21:11:50+08:00" />
<meta property="article:modified_time" content="2023-07-27T21:11:50+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="æ‰©æ•£æ¨¡å‹"/>
<meta name="twitter:description" content="æ‰©æ•£æ¨¡å‹å­¦ä¹ ç¬”è®° æ€è·¯ è®­ç»ƒä¸ªæ•°ä¸ºTï¼ˆæ—¶åˆ»æ•°ï¼‰çš„ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚é€šè¿‡æ­£å‘æ‰©æ•£è·å¾—æ¯ä¸ªæ—¶åˆ»tçš„å‡å€¼å’Œæ–¹å·®ã€‚åˆ©ç”¨é‡å‚æ•°åŒ–æŠ€å·§ï¼Œå°†éšæœºæ€§è½¬ç§»åˆ°$\epsilon$ä¸Šï¼Œæ•´ä¸ªè¿‡ç¨‹çœ‹ä½œæ˜¯é©¬å°”å¯å¤«è¿‡ç¨‹ï¼Œæ¯ä¸ªæ—¶åˆ»çš„åˆ†å¸ƒå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ ¹æ®ä¸‹åˆ—å…¬å¼å¯ä»¥å¾—åˆ°ä»»æ„æ—¶åˆ»çš„$q(x_t|x_{t-1})$
å­¦ä¹ $p_\theta$å»è¿‘ä¼¼q()ï¼Œæ ¹æ®è´å¶æ–¯å¯ä»¥ç®—å‡ºé€†å‘è¿‡ç¨‹qçš„å‡å€¼å’Œæ–¹å·®ï¼š
ä¸Šè¿°å…¬å¼çš„å‡å€¼ä¸º$b\over -2a$ï¼Œæ–¹å·®ä¸º$1\over a$,è®¡ç®—pçš„å¯¹æ•°æŸå¤±ï¼Œä½¿å…¶æœ€å¤§ï¼Œ
ç»è¿‡ç®€åŒ–åçš„å¯¹æ•°æŸå¤±ï¼Œä¸”å› ä¸ºæ–¹å·®æ˜¯å¸¸æ•°ï¼Œå¯ä¼˜åŒ–çš„åªæœ‰å‡å€¼ï¼š æœ€åã€‚å­¦ä¹ ä¸€ä¸ª$\epsilon_\theta$å»é€¼è¿‘$\epsilon_t$
é‡å‚æ•°åŒ–æŠ€å·§ åœ¨é«˜æ–¯åˆ†å¸ƒ$\aleph(\mu,sigma^2)$ä¸­é‡‡æ ·æ˜¯ä¸€ä¸ªéšæœºè¿‡ç¨‹ï¼Œä¸èƒ½è¿›è¡Œåå‘ä¼ æ’­æ¢¯åº¦ï¼Œå¯ä»¥å…ˆä»æ ‡å‡†åˆ†å¸ƒ$\aleph(0ï¼Œ1)$ä¸­é‡‡æ ·ï¼Œå¾—åˆ°$\sigma*\epsilon&#43;\mu$å°†éšæœºæ€§è½¬ç§»åˆ°è¿™ä¸ª$\epsilon$å¸¸é‡ä¸Š
1.å¯¼å…¥æ•°æ® %matplotlib inline import matplotlib.pyplot as plt import numpy as np from sklearn.datasets import make_s_curve import torch s_curve,_ = make_s_curve(10**4,noise=0.1) s_curve = s_curve[:,[0,2]]/10.0 print(&#34;shape of s:&#34;,np.shape(s_curve)) #æ ·æœ¬ç»´åº¦è½¬åŒ–ä¸ºç‰¹å¾ç»´åº¦ data = s_curve.T fig,ax = plt.subplots() ax.scatter(*data,color=&#39;blue&#39;,edgecolor=&#39;white&#39;); ax.axis(&#39;off&#39;) dataset = torch.Tensor(s_curve).float() 2. ç¡®å®šè¶…å‚æ•°çš„å€¼ num_steps = 100 #åˆ¶å®šæ¯ä¸€æ­¥çš„beta betas = torch.linspace(-6,6,num_steps) betas = torch.sigmoid(betas)*(0.5e-2 - 1e-5)&#43;1e-5 #è®¡ç®—alphaã€alpha_prodã€alpha_prod_previousã€alpha_bar_sqrtç­‰å˜é‡çš„å€¼ alphas = 1-betas alphas_prod = torch.cumprod(alphas,0) alphas_prod_p = torch."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "æ‰©æ•£æ¨¡å‹",
      "item": "answerboom.github.io/articles/2023/07/27/diffusion-models-note/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "æ‰©æ•£æ¨¡å‹",
  "name": "æ‰©æ•£æ¨¡å‹",
  "description": "æ‰©æ•£æ¨¡å‹å­¦ä¹ ç¬”è®° æ€è·¯ è®­ç»ƒä¸ªæ•°ä¸ºTï¼ˆæ—¶åˆ»æ•°ï¼‰çš„ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚é€šè¿‡æ­£å‘æ‰©æ•£è·å¾—æ¯ä¸ªæ—¶åˆ»tçš„å‡å€¼å’Œæ–¹å·®ã€‚åˆ©ç”¨é‡å‚æ•°åŒ–æŠ€å·§ï¼Œå°†éšæœºæ€§è½¬ç§»åˆ°$\\epsilon$ä¸Šï¼Œæ•´ä¸ªè¿‡ç¨‹çœ‹ä½œæ˜¯é©¬å°”å¯å¤«è¿‡ç¨‹ï¼Œæ¯ä¸ªæ—¶åˆ»çš„åˆ†å¸ƒå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ ¹æ®ä¸‹åˆ—å…¬å¼å¯ä»¥å¾—åˆ°ä»»æ„æ—¶åˆ»çš„$q(x_t|x_{t-1})$\nå­¦ä¹ $p_\\theta$å»è¿‘ä¼¼q()ï¼Œæ ¹æ®è´å¶æ–¯å¯ä»¥ç®—å‡ºé€†å‘è¿‡ç¨‹qçš„å‡å€¼å’Œæ–¹å·®ï¼š\nä¸Šè¿°å…¬å¼çš„å‡å€¼ä¸º$b\\over -2a$ï¼Œæ–¹å·®ä¸º$1\\over a$,è®¡ç®—pçš„å¯¹æ•°æŸå¤±ï¼Œä½¿å…¶æœ€å¤§ï¼Œ\nç»è¿‡ç®€åŒ–åçš„å¯¹æ•°æŸå¤±ï¼Œä¸”å› ä¸ºæ–¹å·®æ˜¯å¸¸æ•°ï¼Œå¯ä¼˜åŒ–çš„åªæœ‰å‡å€¼ï¼š æœ€åã€‚å­¦ä¹ ä¸€ä¸ª$\\epsilon_\\theta$å»é€¼è¿‘$\\epsilon_t$\né‡å‚æ•°åŒ–æŠ€å·§ åœ¨é«˜æ–¯åˆ†å¸ƒ$\\aleph(\\mu,sigma^2)$ä¸­é‡‡æ ·æ˜¯ä¸€ä¸ªéšæœºè¿‡ç¨‹ï¼Œä¸èƒ½è¿›è¡Œåå‘ä¼ æ’­æ¢¯åº¦ï¼Œå¯ä»¥å…ˆä»æ ‡å‡†åˆ†å¸ƒ$\\aleph(0ï¼Œ1)$ä¸­é‡‡æ ·ï¼Œå¾—åˆ°$\\sigma*\\epsilon+\\mu$å°†éšæœºæ€§è½¬ç§»åˆ°è¿™ä¸ª$\\epsilon$å¸¸é‡ä¸Š\n1.å¯¼å…¥æ•°æ® %matplotlib inline import matplotlib.pyplot as plt import numpy as np from sklearn.datasets import make_s_curve import torch s_curve,_ = make_s_curve(10**4,noise=0.1) s_curve = s_curve[:,[0,2]]/10.0 print(\u0026#34;shape of s:\u0026#34;,np.shape(s_curve)) #æ ·æœ¬ç»´åº¦è½¬åŒ–ä¸ºç‰¹å¾ç»´åº¦ data = s_curve.T fig,ax = plt.subplots() ax.scatter(*data,color=\u0026#39;blue\u0026#39;,edgecolor=\u0026#39;white\u0026#39;); ax.axis(\u0026#39;off\u0026#39;) dataset = torch.Tensor(s_curve).float() 2. ç¡®å®šè¶…å‚æ•°çš„å€¼ num_steps = 100 #åˆ¶å®šæ¯ä¸€æ­¥çš„beta betas = torch.linspace(-6,6,num_steps) betas = torch.sigmoid(betas)*(0.5e-2 - 1e-5)+1e-5 #è®¡ç®—alphaã€alpha_prodã€alpha_prod_previousã€alpha_bar_sqrtç­‰å˜é‡çš„å€¼ alphas = 1-betas alphas_prod = torch.cumprod(alphas,0) alphas_prod_p = torch.",
  "keywords": [
    "æ‰©æ•£æ¨¡å‹"
  ],
  "articleBody": "æ‰©æ•£æ¨¡å‹å­¦ä¹ ç¬”è®° æ€è·¯ è®­ç»ƒä¸ªæ•°ä¸ºTï¼ˆæ—¶åˆ»æ•°ï¼‰çš„ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚é€šè¿‡æ­£å‘æ‰©æ•£è·å¾—æ¯ä¸ªæ—¶åˆ»tçš„å‡å€¼å’Œæ–¹å·®ã€‚åˆ©ç”¨é‡å‚æ•°åŒ–æŠ€å·§ï¼Œå°†éšæœºæ€§è½¬ç§»åˆ°$\\epsilon$ä¸Šï¼Œæ•´ä¸ªè¿‡ç¨‹çœ‹ä½œæ˜¯é©¬å°”å¯å¤«è¿‡ç¨‹ï¼Œæ¯ä¸ªæ—¶åˆ»çš„åˆ†å¸ƒå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ ¹æ®ä¸‹åˆ—å…¬å¼å¯ä»¥å¾—åˆ°ä»»æ„æ—¶åˆ»çš„$q(x_t|x_{t-1})$\nå­¦ä¹ $p_\\theta$å»è¿‘ä¼¼q()ï¼Œæ ¹æ®è´å¶æ–¯å¯ä»¥ç®—å‡ºé€†å‘è¿‡ç¨‹qçš„å‡å€¼å’Œæ–¹å·®ï¼š\nä¸Šè¿°å…¬å¼çš„å‡å€¼ä¸º$b\\over -2a$ï¼Œæ–¹å·®ä¸º$1\\over a$,è®¡ç®—pçš„å¯¹æ•°æŸå¤±ï¼Œä½¿å…¶æœ€å¤§ï¼Œ\nç»è¿‡ç®€åŒ–åçš„å¯¹æ•°æŸå¤±ï¼Œä¸”å› ä¸ºæ–¹å·®æ˜¯å¸¸æ•°ï¼Œå¯ä¼˜åŒ–çš„åªæœ‰å‡å€¼ï¼š æœ€åã€‚å­¦ä¹ ä¸€ä¸ª$\\epsilon_\\theta$å»é€¼è¿‘$\\epsilon_t$\né‡å‚æ•°åŒ–æŠ€å·§ åœ¨é«˜æ–¯åˆ†å¸ƒ$\\aleph(\\mu,sigma^2)$ä¸­é‡‡æ ·æ˜¯ä¸€ä¸ªéšæœºè¿‡ç¨‹ï¼Œä¸èƒ½è¿›è¡Œåå‘ä¼ æ’­æ¢¯åº¦ï¼Œå¯ä»¥å…ˆä»æ ‡å‡†åˆ†å¸ƒ$\\aleph(0ï¼Œ1)$ä¸­é‡‡æ ·ï¼Œå¾—åˆ°$\\sigma*\\epsilon+\\mu$å°†éšæœºæ€§è½¬ç§»åˆ°è¿™ä¸ª$\\epsilon$å¸¸é‡ä¸Š\n1.å¯¼å…¥æ•°æ® %matplotlib inline import matplotlib.pyplot as plt import numpy as np from sklearn.datasets import make_s_curve import torch s_curve,_ = make_s_curve(10**4,noise=0.1) s_curve = s_curve[:,[0,2]]/10.0 print(\"shape of s:\",np.shape(s_curve)) #æ ·æœ¬ç»´åº¦è½¬åŒ–ä¸ºç‰¹å¾ç»´åº¦ data = s_curve.T fig,ax = plt.subplots() ax.scatter(*data,color='blue',edgecolor='white'); ax.axis('off') dataset = torch.Tensor(s_curve).float() 2. ç¡®å®šè¶…å‚æ•°çš„å€¼ num_steps = 100 #åˆ¶å®šæ¯ä¸€æ­¥çš„beta betas = torch.linspace(-6,6,num_steps) betas = torch.sigmoid(betas)*(0.5e-2 - 1e-5)+1e-5 #è®¡ç®—alphaã€alpha_prodã€alpha_prod_previousã€alpha_bar_sqrtç­‰å˜é‡çš„å€¼ alphas = 1-betas alphas_prod = torch.cumprod(alphas,0) alphas_prod_p = torch.cat([torch.tensor([1]).float(),alphas_prod[:-1]],0) alphas_bar_sqrt = torch.sqrt(alphas_prod) one_minus_alphas_bar_log = torch.log(1 - alphas_prod) one_minus_alphas_bar_sqrt = torch.sqrt(1 - alphas_prod) assert alphas.shape==alphas_prod.shape==alphas_prod_p.shape==\\ alphas_bar_sqrt.shape==one_minus_alphas_bar_log.shape\\ ==one_minus_alphas_bar_sqrt.shape print(\"all the same shape\",betas.shape) 3. ç¡®å®šæ‰©æ•£è¿‡ç¨‹ä»»æ„æ—¶åˆ»çš„é‡‡æ ·å€¼ #è®¡ç®—ä»»æ„æ—¶åˆ»çš„xé‡‡æ ·å€¼ï¼ŒåŸºäºx_0å’Œé‡å‚æ•°åŒ– def q_x(x_0,t): \"\"\"å¯ä»¥åŸºäºx[0]å¾—åˆ°ä»»æ„æ—¶åˆ»tçš„x[t]\"\"\" noise = torch.randn_like(x_0) alphas_t = alphas_bar_sqrt[t] alphas_1_m_t = one_minus_alphas_bar_sqrt[t] return (alphas_t * x_0 + alphas_1_m_t * noise)#åœ¨x[0]çš„åŸºç¡€ä¸Šæ·»åŠ å™ªå£° 4. å®šä¹‰ç½‘ç»œæ¨¡å‹ import torch import torch.nn as nn class MLPDiffusion(nn.Module): def __init__(self,n_steps,num_units=128): super(MLPDiffusion,self).__init__() self.linears = nn.ModuleList( [ nn.Linear(2,num_units), nn.ReLU(), nn.Linear(num_units,num_units), nn.ReLU(), nn.Linear(num_units,num_units), nn.ReLU(), nn.Linear(num_units,2), ] ) self.step_embeddings = nn.ModuleList( [\t# å®šä¹‰ä¸€ä¸ªå¤§å°ä¸ºæ—¶é—´tï¼Œç»´åº¦ä¸º128çš„æŸ¥è¯¢è¡¨ nn.Embedding(n_steps,num_units), nn.Embedding(n_steps,num_units), nn.Embedding(n_steps,num_units), ] ) def forward(self,x,t): # x = x_0 for idx,embedding_layer in enumerate(self.step_embeddings): t_embedding = embedding_layer(t) # 2*idx è¡¨ç¤ºé€šè¿‡ç´¢å¼• idx è®¿é—®æ¨¡å—åˆ—è¡¨ä¸­çš„çº¿æ€§å±‚ï¼Œå› ä¸ºæ¯ä¸ªçº¿æ€§å±‚åé¢ç´§è·Ÿç€ä¸€ä¸ªæ¿€æ´»å‡½æ•°å±‚ã€‚0ã€2ã€4 x = self.linears[2*idx](x) x += t_embedding x = self.linears[2*idx+1](x) x = self.linears[-1](x) return x embeddingçš„ç†è§£ embedding = nn.Embedding(embeddings_nums,embeddings_dim) # ä¾‹å¦‚ï¼ˆ5ï¼Œ3ï¼‰ \"\"\" print(embedding): tensor([[-1.8056, 0.1836, -1.4376], [ 0.8409, 0.1034, -1.3735], [-1.3317, 0.8350, -1.7235], [ 1.5251, -0.2363, -0.6729], [ 0.4148, -0.0923, 0.2459]], requires_grad=True) \"\"\" embeddings_numsï¼šæŸ¥è¯¢è¡¨çš„å¤§å° embeddings_dimï¼šæ¯ä¸ªæŸ¥è¯¢å‘é‡çš„ç»´åº¦ å®šä¹‰ä¸€ä¸ªå…·æœ‰embeddings_numsä¸ªå•è¯ï¼Œç»´åº¦ä¸ºdimçš„æŸ¥è¯¢çŸ©é˜µ\nout = embdding(0) # è¡¨ç¤ºè·å–æŸ¥è¯¢çŸ©é˜µä¸­IDä¸º0çš„æŸ¥è¯¢å‘é‡ # out = [-1.8056, 0.1836, -1.4376] 5. è®­ç»ƒçš„è¯¯å·®å‡½æ•° é€†å‘è¿‡ç¨‹ç®—å‡ºçš„å‡å€¼å’Œæ¨¡å‹é¢„æµ‹å‡ºçš„å‡å€¼ç®—äº†ä¸ªå‡æ–¹è¯¯å·®ï¼Œå±•å¼€æˆå™ªå£°çš„å‡æ–¹è¯¯å·®\ndef diffusion_loss_fn(model,x_0,alphas_bar_sqrt,one_minus_alphas_bar_sqrt,n_steps): \"\"\"å¯¹ä»»æ„æ—¶åˆ»tè¿›è¡Œé‡‡æ ·è®¡ç®—loss\"\"\" batch_size = x_0.shape[0] #å¯¹ä¸€ä¸ªbatchsizeæ ·æœ¬ç”Ÿæˆéšæœºçš„æ—¶åˆ»t t = torch.randint(0,n_steps,size=(batch_size//2,)) t = torch.cat([t,n_steps-1-t],dim=0) #[batch_size] t = t.unsqueeze(-1)\t#[batch_size] \"\"\" print(t.shape)ä¸º(128,1) \"\"\" #x0çš„ç³»æ•° a = alphas_bar_sqrt[t] # a.shapeä¸º(128,1) #epsçš„ç³»æ•° aml = one_minus_alphas_bar_sqrt[t] #ç”Ÿæˆéšæœºå™ªéŸ³eps e = torch.randn_like(x_0) #æ„é€ æ¨¡å‹çš„è¾“å…¥ #è¿™é‡Œxçš„ç»´åº¦ä¸º(128ï¼Œ2)ï¼Œaçš„ç»´åº¦ä¸º(128,1),ç»´åº¦ç›¸åŒæ‰èƒ½è¿›è¡Œ*ï¼Œè‹¥ä¸å¯¹t.unsqueeze(-1)ï¼Œåˆ™açš„ç»´åº¦ä¸º(128)ï¼Œä¸èƒ½è¿›è¡Œè¿ç®— x = x_0*a+e*aml #é€å…¥æ¨¡å‹ï¼Œå¾—åˆ°tæ—¶åˆ»çš„éšæœºå™ªå£°é¢„æµ‹å€¼ output = model(x,t.squeeze(-1)) #ä¸çœŸå®å™ªå£°ä¸€èµ·è®¡ç®—è¯¯å·®ï¼Œæ±‚å¹³å‡å€¼ return (e - output).square().mean() 6. é€†æ‰©æ•£é‡‡æ ·å‡½æ•°ï¼ˆinferenceï¼‰ def p_sample_loop(model,shape,n_steps,betas,one_minus_alphas_bar_sqrt): \"\"\"ä»x[T]æ¢å¤x[T-1]ã€x[T-2]|...x[0]\"\"\" cur_x = torch.randn(shape) x_seq = [cur_x] for i in reversed(range(n_steps)): cur_x = p_sample(model,cur_x,i,betas,one_minus_alphas_bar_sqrt) x_seq.append(cur_x) return x_seq def p_sample(model,x,t,betas,one_minus_alphas_bar_sqrt): \"\"\"ä»x[T]é‡‡æ ·tæ—¶åˆ»çš„é‡æ„å€¼\"\"\" t = torch.tensor([t]) coeff = betas[t] / one_minus_alphas_bar_sqrt[t] eps_theta = model(x,t) mean = (1/(1-betas[t]).sqrt())*(x-(coeff*eps_theta)) z = torch.randn_like(x) sigma_t = betas[t].sqrt() sample = mean + sigma_t * z return (sample) 7. å¼€å§‹è®­ç»ƒæ¨¡å‹ seed = 1234 class EMA(): \"\"\"æ„å»ºä¸€ä¸ªå‚æ•°å¹³æ»‘å™¨\"\"\" def __init__(self,mu=0.01): self.mu = mu self.shadow = {} def register(self,name,val): self.shadow[name] = val.clone() def __call__(self,name,x): assert name in self.shadow new_average = self.mu * x + (1.0-self.mu)*self.shadow[name] self.shadow[name] = new_average.clone() return new_average print('Training model...') batch_size = 128 dataloader = torch.utils.data.DataLoader(dataset,batch_size=batch_size,shuffle=True) num_epoch = 4000 plt.rc('text',color='blue') model = MLPDiffusion(num_steps)#è¾“å‡ºç»´åº¦æ˜¯2ï¼Œè¾“å…¥æ˜¯xå’Œstep optimizer = torch.optim.Adam(model.parameters(),lr=1e-3) for t in range(num_epoch): for idx,batch_x in enumerate(dataloader): loss = diffusion_loss_fn(model,batch_x,alphas_bar_sqrt,one_minus_alphas_bar_sqrt,num_steps) optimizer.zero_grad() loss.backward() torch.nn.utils.clip_grad_norm_(model.parameters(),1.) optimizer.step() if(t%100==0): print(loss) x_seq = p_sample_loop(model,dataset.shape,num_steps,betas,one_minus_alphas_bar_sqrt) fig,axs = plt.subplots(1,10,figsize=(28,3)) for i in range(1,11): cur_x = x_seq[i*10].detach() axs[i-1].scatter(cur_x[:,0],cur_x[:,1],color='red',edgecolor='white'); axs[i-1].set_axis_off(); axs[i-1].set_title('$q(\\mathbf{x}_{'+str(i*10)+'})$') å‚æ•°å¹³æ»‘å™¨ â€‹\tä¸Šè¿°ä»£ç å®šä¹‰äº†ä¸€ä¸ªå‚æ•°å¹³æ»‘å™¨ EMAï¼Œç”¨äºå¯¹æ¨¡å‹çš„å‚æ•°è¿›è¡Œå¹³æ»‘å¤„ç†ã€‚è¯¥ç±»çš„ä¸»è¦åŠŸèƒ½æ˜¯ç»´æŠ¤ä¸€ä¸ªå½±å­å‚æ•°å­—å…¸ shadowï¼Œå…¶ä¸­ä¿å­˜äº†æ¯ä¸ªå‚æ•°çš„å¹³æ»‘åçš„æ•°å€¼ã€‚\nâ€‹\tæ„é€ å‡½æ•° __init__ ä¸­æ¥æ”¶ä¸€ä¸ªå‚æ•° muï¼Œç”¨äºæ§åˆ¶å¹³æ»‘çš„ç¨‹åº¦ï¼Œé»˜è®¤ä¸º 0.01ã€‚\nâ€‹\tregister æ–¹æ³•ç”¨äºæ³¨å†Œå‚æ•°ï¼Œå°†å‚æ•°çš„åç§°å’Œåˆå§‹å€¼ä¿å­˜åˆ°å½±å­å‚æ•°å­—å…¸ shadow ä¸­ã€‚\nâ€‹\t__call__ æ–¹æ³•ç”¨äºå¯¹æŒ‡å®šå‚æ•°è¿›è¡Œå¹³æ»‘å¤„ç†ã€‚å®ƒæ¥æ”¶å‚æ•°åç§° name å’Œå‚æ•°å€¼ xï¼Œé¦–å…ˆæ£€æŸ¥å‚æ•°åç§°æ˜¯å¦å­˜åœ¨äºå½±å­å‚æ•°å­—å…¸ shadow ä¸­ï¼Œç„¶åæ ¹æ®æŒ‡å®šçš„å¹³æ»‘ç³»æ•° muï¼Œè®¡ç®—æ–°çš„å¹³æ»‘å‚æ•°å€¼ new_averageï¼Œå¹¶æ›´æ–°å½±å­å‚æ•°å­—å…¸ä¸­çš„å¯¹åº”æ•°å€¼ã€‚æœ€åè¿”å›æ–°çš„å¹³æ»‘å‚æ•°å€¼ã€‚\nâ€‹\té€šè¿‡ä½¿ç”¨ EMA ç±»ï¼Œå¯ä»¥å®ç°å¯¹æ¨¡å‹å‚æ•°çš„å¹³æ»‘æ›´æ–°ï¼Œä½¿æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­çš„å‚æ•°å˜åŒ–æ›´åŠ å¹³ç¼“ã€‚è¿™å¯ä»¥æœ‰åŠ©äºæé«˜æ¨¡å‹çš„ç¨³å®šæ€§å’Œæ”¶æ•›æ€§ã€‚\nè®­ç»ƒè¿‡ç¨‹ â€‹\ttorch.nn.utils.clip_grad_norm_ æ˜¯ä¸€ä¸ªç”¨äºæ¢¯åº¦è£å‰ªçš„å‡½æ•°ï¼Œå®ƒå¯ä»¥å¸®åŠ©é™åˆ¶æ¢¯åº¦çš„èŒƒæ•°ï¼Œé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸é—®é¢˜ã€‚clip_grad_norm_ å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šparameters å’Œ max_normã€‚parameters æ˜¯æ¨¡å‹çš„å‚æ•°åˆ—è¡¨ï¼Œè€Œ max_norm æ˜¯ç”¨äºè£å‰ªæ¢¯åº¦çš„æœ€å¤§èŒƒæ•°å€¼ã€‚\nâ€‹\tåœ¨ä»£ç ä¸­ï¼Œtorch.nn.utils.clip_grad_norm_(model.parameters(), 1.) è¡¨ç¤ºå¯¹æ¨¡å‹çš„æ‰€æœ‰å‚æ•°è¿›è¡Œæ¢¯åº¦è£å‰ªï¼Œå°†æ¢¯åº¦çš„èŒƒæ•°é™åˆ¶åœ¨ 1.0 å†…ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ¢¯åº¦ä¸ä¼šè¿‡å¤§ï¼Œé¿å…è®­ç»ƒè¿‡ç¨‹ä¸­çš„ä¸ç¨³å®šæ€§ã€‚\nâ€‹\tæ¥ä¸‹æ¥ï¼Œoptimizer.step() æ˜¯ä¼˜åŒ–å™¨çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºæ›´æ–°æ¨¡å‹çš„å‚æ•°ã€‚å®ƒæ ¹æ®è®¡ç®—å¾—åˆ°çš„æ¢¯åº¦æ¥æ›´æ–°å‚æ•°ï¼Œä½¿æ¨¡å‹å‘æ›´å¥½çš„æ–¹å‘å‰è¿›ã€‚é€šè¿‡æ‰§è¡Œ optimizer.step()ï¼Œå¯ä»¥ä½¿æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¸æ–­ä¼˜åŒ–å’Œæ›´æ–°ã€‚\nè®¤è¯†dataloader dataloader = torch.utils.data.DataLoader(dataset,batch_size=batch_size,shuffle=True) â€‹\ttorch.utils.data.DataLoader æ˜¯ PyTorch ä¸­ç”¨äºåŠ è½½æ•°æ®çš„å·¥å…·ç±»ã€‚åœ¨ç»™å®šæ•°æ®é›† dataset çš„æƒ…å†µä¸‹ï¼ŒDataLoader å¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»¥æŒ‡å®šçš„æ‰¹é‡å¤§å° batch_size åŠ è½½æ•°æ®ï¼Œå¹¶æä¾›ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œå¦‚æ•°æ®æ‰“ä¹±ï¼ˆé€šè¿‡è®¾ç½® shuffle=Trueï¼‰å’Œå¹¶è¡ŒåŠ è½½æ•°æ®ã€‚\nâ€‹\tå…·ä½“æ¥è¯´ï¼Œä¸Šè¿°ä»£ç åˆ›å»ºäº†ä¸€ä¸ª DataLoader å¯¹è±¡ dataloaderï¼Œå®ƒå°†æ•°æ®é›† dataset åˆ†æˆä»¥ batch_size ä¸ºå¤§å°çš„æ‰¹æ¬¡ã€‚è®¾ç½® shuffle=True è¡¨ç¤ºåœ¨æ¯ä¸ª epoch ä¸­å¯¹æ•°æ®è¿›è¡Œæ‰“ä¹±ï¼Œä»¥å¢åŠ æ•°æ®çš„éšæœºæ€§ã€‚\nâ€‹\té€šè¿‡ä½¿ç”¨ dataloaderï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°è¿­ä»£éå†æ•°æ®é›†ï¼Œæ¯æ¬¡è¿­ä»£è·å¾—ä¸€ä¸ªæ‰¹æ¬¡çš„æ•°æ®ï¼Œæ–¹ä¾¿è¿›è¡Œè®­ç»ƒæˆ–æ¨æ–­æ“ä½œã€‚\nå‚è€ƒ [ä»€ä¹ˆæ˜¯æ‰©æ•£æ¨¡å‹ï¼Ÿ |åˆ©å°”æ—¥å¿— (lilianweng.github.io)](https://lilianweng.github.io/posts/2021-07-11-diffusion-models/#:~:text=Diffusion models are inspired by non-equilibrium thermodynamics. They,to construct desired data samples from the noise.)\nProbabilistic Diffusion Modelæ¦‚ç‡æ‰©æ•£æ¨¡å‹ç†è®ºä¸å®Œæ•´PyTorchä»£ç è¯¦ç»†è§£è¯»_å“”å“©å“”å“©_bilibili\ndeep_thoughtsçš„æ‰©æ•£æ¨¡å‹ç¬”è®° (bilibili.com)\n",
  "wordCount" : "527",
  "inLanguage": "en",
  "datePublished": "2023-07-27T21:11:50+08:00",
  "dateModified": "2023-07-27T21:11:50+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "answerboom.github.io/articles/2023/07/27/diffusion-models-note/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ğŸ» liyBlog",
    "logo": {
      "@type": "ImageObject",
      "url": "answerboom.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="answerboom.github.io" accesskey="h" title="ğŸ» liyBlog (Alt + H)">ğŸ» liyBlog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="answerboom.github.io/answerboom.github.io/" title="ä¸»é¡µ">
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="answerboom.github.io/answerboom.github.io/archives/" title="å½’æ¡£">
                    <span>å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="answerboom.github.io/answerboom.github.io/categories/" title="åˆ†ç±»">
                    <span>åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="answerboom.github.io/answerboom.github.io/tags/" title="æ ‡ç­¾">
                    <span>æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="answerboom.github.io/answerboom.github.io/search/" title="æŸ¥æ‰¾ (Alt &#43; /)" accesskey=/>
                    <span>æŸ¥æ‰¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="answerboom.github.io">Home</a></div>
    <h1 class="post-title">
      æ‰©æ•£æ¨¡å‹
    </h1>
    <div class="post-meta"><span title='2023-07-27 21:11:50 +0800 CST'>July 27, 2023</span>&nbsp;Â·&nbsp;3 min

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%89%a9%e6%95%a3%e6%a8%a1%e5%9e%8b%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0" aria-label="æ‰©æ•£æ¨¡å‹å­¦ä¹ ç¬”è®°">æ‰©æ•£æ¨¡å‹å­¦ä¹ ç¬”è®°</a><ul>
                        
                <li>
                    <a href="#%e6%80%9d%e8%b7%af" aria-label="æ€è·¯">æ€è·¯</a><ul>
                        
                <li>
                    <a href="#%e9%87%8d%e5%8f%82%e6%95%b0%e5%8c%96%e6%8a%80%e5%b7%a7" aria-label="é‡å‚æ•°åŒ–æŠ€å·§">é‡å‚æ•°åŒ–æŠ€å·§</a></li></ul>
                </li>
                <li>
                    <a href="#1%e5%af%bc%e5%85%a5%e6%95%b0%e6%8d%ae" aria-label="1.å¯¼å…¥æ•°æ®">1.å¯¼å…¥æ•°æ®</a></li>
                <li>
                    <a href="#2-%e7%a1%ae%e5%ae%9a%e8%b6%85%e5%8f%82%e6%95%b0%e7%9a%84%e5%80%bc" aria-label="2. ç¡®å®šè¶…å‚æ•°çš„å€¼">2. ç¡®å®šè¶…å‚æ•°çš„å€¼</a></li>
                <li>
                    <a href="#3-%e7%a1%ae%e5%ae%9a%e6%89%a9%e6%95%a3%e8%bf%87%e7%a8%8b%e4%bb%bb%e6%84%8f%e6%97%b6%e5%88%bb%e7%9a%84%e9%87%87%e6%a0%b7%e5%80%bc" aria-label="3. ç¡®å®šæ‰©æ•£è¿‡ç¨‹ä»»æ„æ—¶åˆ»çš„é‡‡æ ·å€¼">3. ç¡®å®šæ‰©æ•£è¿‡ç¨‹ä»»æ„æ—¶åˆ»çš„é‡‡æ ·å€¼</a></li>
                <li>
                    <a href="#4-%e5%ae%9a%e4%b9%89%e7%bd%91%e7%bb%9c%e6%a8%a1%e5%9e%8b" aria-label="4. å®šä¹‰ç½‘ç»œæ¨¡å‹">4. å®šä¹‰ç½‘ç»œæ¨¡å‹</a><ul>
                        
                <li>
                    <a href="#embedding%e7%9a%84%e7%90%86%e8%a7%a3" aria-label="embeddingçš„ç†è§£">embeddingçš„ç†è§£</a></li></ul>
                </li>
                <li>
                    <a href="#5-%e8%ae%ad%e7%bb%83%e7%9a%84%e8%af%af%e5%b7%ae%e5%87%bd%e6%95%b0" aria-label="5. è®­ç»ƒçš„è¯¯å·®å‡½æ•°">5. è®­ç»ƒçš„è¯¯å·®å‡½æ•°</a></li>
                <li>
                    <a href="#6-%e9%80%86%e6%89%a9%e6%95%a3%e9%87%87%e6%a0%b7%e5%87%bd%e6%95%b0inference" aria-label="6. é€†æ‰©æ•£é‡‡æ ·å‡½æ•°ï¼ˆinferenceï¼‰">6. é€†æ‰©æ•£é‡‡æ ·å‡½æ•°ï¼ˆinferenceï¼‰</a></li>
                <li>
                    <a href="#7-%e5%bc%80%e5%a7%8b%e8%ae%ad%e7%bb%83%e6%a8%a1%e5%9e%8b" aria-label="7. å¼€å§‹è®­ç»ƒæ¨¡å‹">7. å¼€å§‹è®­ç»ƒæ¨¡å‹</a><ul>
                        
                <li>
                    <a href="#%e5%8f%82%e6%95%b0%e5%b9%b3%e6%bb%91%e5%99%a8" aria-label="å‚æ•°å¹³æ»‘å™¨">å‚æ•°å¹³æ»‘å™¨</a></li>
                <li>
                    <a href="#%e8%ae%ad%e7%bb%83%e8%bf%87%e7%a8%8b" aria-label="è®­ç»ƒè¿‡ç¨‹">è®­ç»ƒè¿‡ç¨‹</a></li>
                <li>
                    <a href="#%e8%ae%a4%e8%af%86dataloader" aria-label="è®¤è¯†dataloader">è®¤è¯†dataloader</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83" aria-label="å‚è€ƒ">å‚è€ƒ</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="æ‰©æ•£æ¨¡å‹å­¦ä¹ ç¬”è®°">æ‰©æ•£æ¨¡å‹å­¦ä¹ ç¬”è®°<a hidden class="anchor" aria-hidden="true" href="#æ‰©æ•£æ¨¡å‹å­¦ä¹ ç¬”è®°">#</a></h1>
<h2 id="æ€è·¯">æ€è·¯<a hidden class="anchor" aria-hidden="true" href="#æ€è·¯">#</a></h2>
<p><img loading="lazy" src="https://img-blog.csdnimg.cn/29a8c10f2efc4affa2a64612788e3a6e.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"  />

è®­ç»ƒä¸ªæ•°ä¸ºTï¼ˆæ—¶åˆ»æ•°ï¼‰çš„ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚é€šè¿‡æ­£å‘æ‰©æ•£è·å¾—æ¯ä¸ªæ—¶åˆ»tçš„å‡å€¼å’Œæ–¹å·®ã€‚åˆ©ç”¨é‡å‚æ•°åŒ–æŠ€å·§ï¼Œå°†éšæœºæ€§è½¬ç§»åˆ°$\epsilon$ä¸Šï¼Œæ•´ä¸ªè¿‡ç¨‹çœ‹ä½œæ˜¯é©¬å°”å¯å¤«è¿‡ç¨‹ï¼Œæ¯ä¸ªæ—¶åˆ»çš„åˆ†å¸ƒå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ ¹æ®ä¸‹åˆ—å…¬å¼å¯ä»¥å¾—åˆ°ä»»æ„æ—¶åˆ»çš„$q(x_t|x_{t-1})$</p>
<p><img loading="lazy" src="https://img-blog.csdnimg.cn/0fa96f89b3444418aa5d37c783e22079.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"  />
</p>
<p>å­¦ä¹ $p_\theta$å»è¿‘ä¼¼q()ï¼Œæ ¹æ®è´å¶æ–¯å¯ä»¥ç®—å‡ºé€†å‘è¿‡ç¨‹qçš„å‡å€¼å’Œæ–¹å·®ï¼š</p>
<p><img loading="lazy" src="https://img-blog.csdnimg.cn/c29e960533744e52b5f1ff2dae481940.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"  />
</p>
<p>ä¸Šè¿°å…¬å¼çš„å‡å€¼ä¸º$b\over -2a$ï¼Œæ–¹å·®ä¸º$1\over a$,è®¡ç®—pçš„å¯¹æ•°æŸå¤±ï¼Œä½¿å…¶æœ€å¤§ï¼Œ</p>
<p><img loading="lazy" src="https://img-blog.csdnimg.cn/774397863b8140f6868b7a1d83359fca.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"  />

<img loading="lazy" src="https://img-blog.csdnimg.cn/befd7e73d7734bb6ab3030ca4c180a54.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"  />
</p>
<p>ç»è¿‡ç®€åŒ–åçš„å¯¹æ•°æŸå¤±ï¼Œä¸”å› ä¸ºæ–¹å·®æ˜¯å¸¸æ•°ï¼Œå¯ä¼˜åŒ–çš„åªæœ‰å‡å€¼ï¼š
<img loading="lazy" src="https://img-blog.csdnimg.cn/58495f9916884f48ae3294b3f4f3073f.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"  />
</p>
<p>æœ€åã€‚å­¦ä¹ ä¸€ä¸ª$\epsilon_\theta$å»é€¼è¿‘$\epsilon_t$</p>
<h3 id="é‡å‚æ•°åŒ–æŠ€å·§">é‡å‚æ•°åŒ–æŠ€å·§<a hidden class="anchor" aria-hidden="true" href="#é‡å‚æ•°åŒ–æŠ€å·§">#</a></h3>
<p>åœ¨é«˜æ–¯åˆ†å¸ƒ$\aleph(\mu,sigma^2)$ä¸­é‡‡æ ·æ˜¯ä¸€ä¸ªéšæœºè¿‡ç¨‹ï¼Œä¸èƒ½è¿›è¡Œåå‘ä¼ æ’­æ¢¯åº¦ï¼Œå¯ä»¥å…ˆä»æ ‡å‡†åˆ†å¸ƒ$\aleph(0ï¼Œ1)$ä¸­é‡‡æ ·ï¼Œå¾—åˆ°$\sigma*\epsilon+\mu$å°†éšæœºæ€§è½¬ç§»åˆ°è¿™ä¸ª$\epsilon$å¸¸é‡ä¸Š</p>
<h2 id="1å¯¼å…¥æ•°æ®">1.å¯¼å…¥æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#1å¯¼å…¥æ•°æ®">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">%</span>matplotlib inline
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.datasets <span style="color:#f92672">import</span> make_s_curve
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s_curve,_ <span style="color:#f92672">=</span> make_s_curve(<span style="color:#ae81ff">10</span><span style="color:#f92672">**</span><span style="color:#ae81ff">4</span>,noise<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>s_curve <span style="color:#f92672">=</span> s_curve[:,[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>]]<span style="color:#f92672">/</span><span style="color:#ae81ff">10.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;shape of s:&#34;</span>,np<span style="color:#f92672">.</span>shape(s_curve))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#æ ·æœ¬ç»´åº¦è½¬åŒ–ä¸ºç‰¹å¾ç»´åº¦</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> s_curve<span style="color:#f92672">.</span>T
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig,ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots()
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>scatter(<span style="color:#f92672">*</span>data,color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;blue&#39;</span>,edgecolor<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;white&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>Tensor(s_curve)<span style="color:#f92672">.</span>float()
</span></span></code></pre></div><h2 id="2-ç¡®å®šè¶…å‚æ•°çš„å€¼">2. ç¡®å®šè¶…å‚æ•°çš„å€¼<a hidden class="anchor" aria-hidden="true" href="#2-ç¡®å®šè¶…å‚æ•°çš„å€¼">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>num_steps <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#åˆ¶å®šæ¯ä¸€æ­¥çš„beta</span>
</span></span><span style="display:flex;"><span>betas <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>linspace(<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">6</span>,num_steps)
</span></span><span style="display:flex;"><span>betas <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>sigmoid(betas)<span style="color:#f92672">*</span>(<span style="color:#ae81ff">0.5e-2</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1e-5</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1e-5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#è®¡ç®—alphaã€alpha_prodã€alpha_prod_previousã€alpha_bar_sqrtç­‰å˜é‡çš„å€¼</span>
</span></span><span style="display:flex;"><span>alphas <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>betas
</span></span><span style="display:flex;"><span>alphas_prod <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cumprod(alphas,<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>alphas_prod_p <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cat([torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">1</span>])<span style="color:#f92672">.</span>float(),alphas_prod[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]],<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>alphas_bar_sqrt <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>sqrt(alphas_prod)
</span></span><span style="display:flex;"><span>one_minus_alphas_bar_log <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>log(<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> alphas_prod)
</span></span><span style="display:flex;"><span>one_minus_alphas_bar_sqrt <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>sqrt(<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> alphas_prod)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> alphas<span style="color:#f92672">.</span>shape<span style="color:#f92672">==</span>alphas_prod<span style="color:#f92672">.</span>shape<span style="color:#f92672">==</span>alphas_prod_p<span style="color:#f92672">.</span>shape<span style="color:#f92672">==</span>\
</span></span><span style="display:flex;"><span>alphas_bar_sqrt<span style="color:#f92672">.</span>shape<span style="color:#f92672">==</span>one_minus_alphas_bar_log<span style="color:#f92672">.</span>shape\
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>one_minus_alphas_bar_sqrt<span style="color:#f92672">.</span>shape
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;all the same shape&#34;</span>,betas<span style="color:#f92672">.</span>shape)
</span></span></code></pre></div><h2 id="3-ç¡®å®šæ‰©æ•£è¿‡ç¨‹ä»»æ„æ—¶åˆ»çš„é‡‡æ ·å€¼">3. ç¡®å®šæ‰©æ•£è¿‡ç¨‹ä»»æ„æ—¶åˆ»çš„é‡‡æ ·å€¼<a hidden class="anchor" aria-hidden="true" href="#3-ç¡®å®šæ‰©æ•£è¿‡ç¨‹ä»»æ„æ—¶åˆ»çš„é‡‡æ ·å€¼">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#è®¡ç®—ä»»æ„æ—¶åˆ»çš„xé‡‡æ ·å€¼ï¼ŒåŸºäºx_0å’Œé‡å‚æ•°åŒ–</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">q_x</span>(x_0,t):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;å¯ä»¥åŸºäºx[0]å¾—åˆ°ä»»æ„æ—¶åˆ»tçš„x[t]&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    noise <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randn_like(x_0)
</span></span><span style="display:flex;"><span>    alphas_t <span style="color:#f92672">=</span> alphas_bar_sqrt[t]
</span></span><span style="display:flex;"><span>    alphas_1_m_t <span style="color:#f92672">=</span> one_minus_alphas_bar_sqrt[t]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (alphas_t <span style="color:#f92672">*</span> x_0 <span style="color:#f92672">+</span> alphas_1_m_t <span style="color:#f92672">*</span> noise)<span style="color:#75715e">#åœ¨x[0]çš„åŸºç¡€ä¸Šæ·»åŠ å™ªå£°</span>
</span></span></code></pre></div><p><img loading="lazy" src="https://img-blog.csdnimg.cn/f6739778329f42e68b155771ead4d015.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"  />
</p>
<h2 id="4-å®šä¹‰ç½‘ç»œæ¨¡å‹">4. å®šä¹‰ç½‘ç»œæ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#4-å®šä¹‰ç½‘ç»œæ¨¡å‹">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn <span style="color:#66d9ef">as</span> nn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MLPDiffusion</span>(nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self,n_steps,num_units<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>):
</span></span><span style="display:flex;"><span>        super(MLPDiffusion,self)<span style="color:#f92672">.</span>__init__()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>linears <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>ModuleList(
</span></span><span style="display:flex;"><span>            [
</span></span><span style="display:flex;"><span>                nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">2</span>,num_units),
</span></span><span style="display:flex;"><span>                nn<span style="color:#f92672">.</span>ReLU(),
</span></span><span style="display:flex;"><span>                nn<span style="color:#f92672">.</span>Linear(num_units,num_units),
</span></span><span style="display:flex;"><span>                nn<span style="color:#f92672">.</span>ReLU(),
</span></span><span style="display:flex;"><span>                nn<span style="color:#f92672">.</span>Linear(num_units,num_units),
</span></span><span style="display:flex;"><span>                nn<span style="color:#f92672">.</span>ReLU(),
</span></span><span style="display:flex;"><span>                nn<span style="color:#f92672">.</span>Linear(num_units,<span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>step_embeddings <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>ModuleList(
</span></span><span style="display:flex;"><span>            [	 
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># å®šä¹‰ä¸€ä¸ªå¤§å°ä¸ºæ—¶é—´tï¼Œç»´åº¦ä¸º128çš„æŸ¥è¯¢è¡¨</span>
</span></span><span style="display:flex;"><span>                nn<span style="color:#f92672">.</span>Embedding(n_steps,num_units),
</span></span><span style="display:flex;"><span>                nn<span style="color:#f92672">.</span>Embedding(n_steps,num_units),
</span></span><span style="display:flex;"><span>                nn<span style="color:#f92672">.</span>Embedding(n_steps,num_units),
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self,x,t):
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         x = x_0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> idx,embedding_layer <span style="color:#f92672">in</span> enumerate(self<span style="color:#f92672">.</span>step_embeddings):
</span></span><span style="display:flex;"><span>            t_embedding <span style="color:#f92672">=</span> embedding_layer(t)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 2*idx è¡¨ç¤ºé€šè¿‡ç´¢å¼• idx è®¿é—®æ¨¡å—åˆ—è¡¨ä¸­çš„çº¿æ€§å±‚ï¼Œå› ä¸ºæ¯ä¸ªçº¿æ€§å±‚åé¢ç´§è·Ÿç€ä¸€ä¸ªæ¿€æ´»å‡½æ•°å±‚ã€‚0ã€2ã€4</span>
</span></span><span style="display:flex;"><span>            x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>linears[<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>idx](x)
</span></span><span style="display:flex;"><span>            x <span style="color:#f92672">+=</span> t_embedding
</span></span><span style="display:flex;"><span>            x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>linears[<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>idx<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>](x)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>linears[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>](x)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> x
</span></span></code></pre></div><h3 id="embeddingçš„ç†è§£">embeddingçš„ç†è§£<a hidden class="anchor" aria-hidden="true" href="#embeddingçš„ç†è§£">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>embedding <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Embedding(embeddings_nums,embeddings_dim)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä¾‹å¦‚ï¼ˆ5ï¼Œ3ï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">print(embedding):
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">tensor([[-1.8056,  0.1836, -1.4376],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ 0.8409,  0.1034, -1.3735],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [-1.3317,  0.8350, -1.7235],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ 1.5251, -0.2363, -0.6729],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        [ 0.4148, -0.0923,  0.2459]], requires_grad=True)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span></code></pre></div><ol>
<li>embeddings_numsï¼šæŸ¥è¯¢è¡¨çš„å¤§å°</li>
<li>embeddings_dimï¼šæ¯ä¸ªæŸ¥è¯¢å‘é‡çš„ç»´åº¦</li>
</ol>
<p>å®šä¹‰ä¸€ä¸ªå…·æœ‰embeddings_numsä¸ªå•è¯ï¼Œç»´åº¦ä¸ºdimçš„æŸ¥è¯¢çŸ©é˜µ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>out <span style="color:#f92672">=</span> embdding(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># è¡¨ç¤ºè·å–æŸ¥è¯¢çŸ©é˜µä¸­IDä¸º0çš„æŸ¥è¯¢å‘é‡</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># out = [-1.8056,  0.1836, -1.4376]</span>
</span></span></code></pre></div><h2 id="5-è®­ç»ƒçš„è¯¯å·®å‡½æ•°">5. è®­ç»ƒçš„è¯¯å·®å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#5-è®­ç»ƒçš„è¯¯å·®å‡½æ•°">#</a></h2>
<p><img loading="lazy" src="https://img-blog.csdnimg.cn/21e48a15f445453d8ae2a45e727a3c6a.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"  />
</p>
<p>é€†å‘è¿‡ç¨‹ç®—å‡ºçš„å‡å€¼å’Œæ¨¡å‹é¢„æµ‹å‡ºçš„å‡å€¼ç®—äº†ä¸ªå‡æ–¹è¯¯å·®ï¼Œå±•å¼€æˆå™ªå£°çš„å‡æ–¹è¯¯å·®</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">diffusion_loss_fn</span>(model,x_0,alphas_bar_sqrt,one_minus_alphas_bar_sqrt,n_steps):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;å¯¹ä»»æ„æ—¶åˆ»tè¿›è¡Œé‡‡æ ·è®¡ç®—loss&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    batch_size <span style="color:#f92672">=</span> x_0<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#å¯¹ä¸€ä¸ªbatchsizeæ ·æœ¬ç”Ÿæˆéšæœºçš„æ—¶åˆ»t</span>
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>,n_steps,size<span style="color:#f92672">=</span>(batch_size<span style="color:#f92672">//</span><span style="color:#ae81ff">2</span>,))
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cat([t,n_steps<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>t],dim<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>) <span style="color:#75715e">#[batch_size]</span>
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span>unsqueeze(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)	<span style="color:#75715e">#[batch_size]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    print(t.shape)ä¸º(128,1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#x0çš„ç³»æ•°</span>
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">=</span> alphas_bar_sqrt[t]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># a.shapeä¸º(128,1)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#epsçš„ç³»æ•°</span>
</span></span><span style="display:flex;"><span>    aml <span style="color:#f92672">=</span> one_minus_alphas_bar_sqrt[t]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#ç”Ÿæˆéšæœºå™ªéŸ³eps</span>
</span></span><span style="display:flex;"><span>    e <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randn_like(x_0)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#æ„é€ æ¨¡å‹çš„è¾“å…¥</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#è¿™é‡Œxçš„ç»´åº¦ä¸º(128ï¼Œ2)ï¼Œaçš„ç»´åº¦ä¸º(128,1),ç»´åº¦ç›¸åŒæ‰èƒ½è¿›è¡Œ*ï¼Œè‹¥ä¸å¯¹t.unsqueeze(-1)ï¼Œåˆ™açš„ç»´åº¦ä¸º(128)ï¼Œä¸èƒ½è¿›è¡Œè¿ç®—</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> x_0<span style="color:#f92672">*</span>a<span style="color:#f92672">+</span>e<span style="color:#f92672">*</span>aml
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#é€å…¥æ¨¡å‹ï¼Œå¾—åˆ°tæ—¶åˆ»çš„éšæœºå™ªå£°é¢„æµ‹å€¼</span>
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> model(x,t<span style="color:#f92672">.</span>squeeze(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#ä¸çœŸå®å™ªå£°ä¸€èµ·è®¡ç®—è¯¯å·®ï¼Œæ±‚å¹³å‡å€¼</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (e <span style="color:#f92672">-</span> output)<span style="color:#f92672">.</span>square()<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><h2 id="6-é€†æ‰©æ•£é‡‡æ ·å‡½æ•°inference">6. é€†æ‰©æ•£é‡‡æ ·å‡½æ•°ï¼ˆinferenceï¼‰<a hidden class="anchor" aria-hidden="true" href="#6-é€†æ‰©æ•£é‡‡æ ·å‡½æ•°inference">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">p_sample_loop</span>(model,shape,n_steps,betas,one_minus_alphas_bar_sqrt):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;ä»x[T]æ¢å¤x[T-1]ã€x[T-2]|...x[0]&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    cur_x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randn(shape)
</span></span><span style="display:flex;"><span>    x_seq <span style="color:#f92672">=</span> [cur_x]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> reversed(range(n_steps)):
</span></span><span style="display:flex;"><span>        cur_x <span style="color:#f92672">=</span> p_sample(model,cur_x,i,betas,one_minus_alphas_bar_sqrt)
</span></span><span style="display:flex;"><span>        x_seq<span style="color:#f92672">.</span>append(cur_x)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> x_seq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">p_sample</span>(model,x,t,betas,one_minus_alphas_bar_sqrt):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;ä»x[T]é‡‡æ ·tæ—¶åˆ»çš„é‡æ„å€¼&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([t])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    coeff <span style="color:#f92672">=</span> betas[t] <span style="color:#f92672">/</span> one_minus_alphas_bar_sqrt[t]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    eps_theta <span style="color:#f92672">=</span> model(x,t)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    mean <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>betas[t])<span style="color:#f92672">.</span>sqrt())<span style="color:#f92672">*</span>(x<span style="color:#f92672">-</span>(coeff<span style="color:#f92672">*</span>eps_theta))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    z <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randn_like(x)
</span></span><span style="display:flex;"><span>    sigma_t <span style="color:#f92672">=</span> betas[t]<span style="color:#f92672">.</span>sqrt()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    sample <span style="color:#f92672">=</span> mean <span style="color:#f92672">+</span> sigma_t <span style="color:#f92672">*</span> z
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (sample)
</span></span></code></pre></div><p><img loading="lazy" src="https://img-blog.csdnimg.cn/a5a590ebfea94606a3b82cb190a48b37.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"  />
</p>
<h2 id="7-å¼€å§‹è®­ç»ƒæ¨¡å‹">7. å¼€å§‹è®­ç»ƒæ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#7-å¼€å§‹è®­ç»ƒæ¨¡å‹">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>seed <span style="color:#f92672">=</span> <span style="color:#ae81ff">1234</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EMA</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;æ„å»ºä¸€ä¸ªå‚æ•°å¹³æ»‘å™¨&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self,mu<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>mu <span style="color:#f92672">=</span> mu
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>shadow <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register</span>(self,name,val):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>shadow[name] <span style="color:#f92672">=</span> val<span style="color:#f92672">.</span>clone()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __call__(self,name,x):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> name <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>shadow
</span></span><span style="display:flex;"><span>        new_average <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>mu <span style="color:#f92672">*</span> x <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1.0</span><span style="color:#f92672">-</span>self<span style="color:#f92672">.</span>mu)<span style="color:#f92672">*</span>self<span style="color:#f92672">.</span>shadow[name]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>shadow[name] <span style="color:#f92672">=</span> new_average<span style="color:#f92672">.</span>clone()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> new_average
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;Training model...&#39;</span>)
</span></span><span style="display:flex;"><span>batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>dataloader <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>DataLoader(dataset,batch_size<span style="color:#f92672">=</span>batch_size,shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>num_epoch <span style="color:#f92672">=</span> <span style="color:#ae81ff">4000</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>rc(<span style="color:#e6db74">&#39;text&#39;</span>,color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;blue&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> MLPDiffusion(num_steps)<span style="color:#75715e">#è¾“å‡ºç»´åº¦æ˜¯2ï¼Œè¾“å…¥æ˜¯xå’Œstep</span>
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Adam(model<span style="color:#f92672">.</span>parameters(),lr<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> t <span style="color:#f92672">in</span> range(num_epoch):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx,batch_x <span style="color:#f92672">in</span> enumerate(dataloader):
</span></span><span style="display:flex;"><span>        loss <span style="color:#f92672">=</span> diffusion_loss_fn(model,batch_x,alphas_bar_sqrt,one_minus_alphas_bar_sqrt,num_steps)
</span></span><span style="display:flex;"><span>        optimizer<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>        loss<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>        torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>clip_grad_norm_(model<span style="color:#f92672">.</span>parameters(),<span style="color:#ae81ff">1.</span>)
</span></span><span style="display:flex;"><span>        optimizer<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(t<span style="color:#f92672">%</span><span style="color:#ae81ff">100</span><span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>        print(loss)
</span></span><span style="display:flex;"><span>        x_seq <span style="color:#f92672">=</span> p_sample_loop(model,dataset<span style="color:#f92672">.</span>shape,num_steps,betas,one_minus_alphas_bar_sqrt)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        fig,axs <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">10</span>,figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">28</span>,<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">11</span>):
</span></span><span style="display:flex;"><span>            cur_x <span style="color:#f92672">=</span> x_seq[i<span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>]<span style="color:#f92672">.</span>detach()
</span></span><span style="display:flex;"><span>            axs[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>scatter(cur_x[:,<span style="color:#ae81ff">0</span>],cur_x[:,<span style="color:#ae81ff">1</span>],color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;red&#39;</span>,edgecolor<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;white&#39;</span>);
</span></span><span style="display:flex;"><span>            axs[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>set_axis_off();
</span></span><span style="display:flex;"><span>            axs[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;$q(\mathbf</span><span style="color:#e6db74">{x}</span><span style="color:#e6db74">_{&#39;</span><span style="color:#f92672">+</span>str(i<span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;})$&#39;</span>)
</span></span></code></pre></div><h3 id="å‚æ•°å¹³æ»‘å™¨">å‚æ•°å¹³æ»‘å™¨<a hidden class="anchor" aria-hidden="true" href="#å‚æ•°å¹³æ»‘å™¨">#</a></h3>
<blockquote>
<p>â€‹	ä¸Šè¿°ä»£ç å®šä¹‰äº†ä¸€ä¸ªå‚æ•°å¹³æ»‘å™¨ <code>EMA</code>ï¼Œç”¨äºå¯¹æ¨¡å‹çš„å‚æ•°è¿›è¡Œå¹³æ»‘å¤„ç†ã€‚è¯¥ç±»çš„ä¸»è¦åŠŸèƒ½æ˜¯ç»´æŠ¤ä¸€ä¸ªå½±å­å‚æ•°å­—å…¸ <code>shadow</code>ï¼Œå…¶ä¸­ä¿å­˜äº†æ¯ä¸ªå‚æ•°çš„å¹³æ»‘åçš„æ•°å€¼ã€‚</p>
<p>â€‹	æ„é€ å‡½æ•° <code>__init__</code> ä¸­æ¥æ”¶ä¸€ä¸ªå‚æ•° <code>mu</code>ï¼Œç”¨äºæ§åˆ¶å¹³æ»‘çš„ç¨‹åº¦ï¼Œé»˜è®¤ä¸º 0.01ã€‚</p>
<p>â€‹	<code>register</code> æ–¹æ³•ç”¨äºæ³¨å†Œå‚æ•°ï¼Œå°†å‚æ•°çš„åç§°å’Œåˆå§‹å€¼ä¿å­˜åˆ°å½±å­å‚æ•°å­—å…¸ <code>shadow</code> ä¸­ã€‚</p>
<p>â€‹	<code>__call__</code> æ–¹æ³•ç”¨äºå¯¹æŒ‡å®šå‚æ•°è¿›è¡Œå¹³æ»‘å¤„ç†ã€‚å®ƒæ¥æ”¶å‚æ•°åç§° <code>name</code> å’Œå‚æ•°å€¼ <code>x</code>ï¼Œé¦–å…ˆæ£€æŸ¥å‚æ•°åç§°æ˜¯å¦å­˜åœ¨äºå½±å­å‚æ•°å­—å…¸ <code>shadow</code> ä¸­ï¼Œç„¶åæ ¹æ®æŒ‡å®šçš„å¹³æ»‘ç³»æ•° <code>mu</code>ï¼Œè®¡ç®—æ–°çš„å¹³æ»‘å‚æ•°å€¼ <code>new_average</code>ï¼Œå¹¶æ›´æ–°å½±å­å‚æ•°å­—å…¸ä¸­çš„å¯¹åº”æ•°å€¼ã€‚æœ€åè¿”å›æ–°çš„å¹³æ»‘å‚æ•°å€¼ã€‚</p>
<p>â€‹	é€šè¿‡ä½¿ç”¨ <code>EMA</code> ç±»ï¼Œå¯ä»¥å®ç°å¯¹æ¨¡å‹å‚æ•°çš„å¹³æ»‘æ›´æ–°ï¼Œä½¿æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­çš„å‚æ•°å˜åŒ–æ›´åŠ å¹³ç¼“ã€‚è¿™å¯ä»¥æœ‰åŠ©äºæé«˜æ¨¡å‹çš„ç¨³å®šæ€§å’Œæ”¶æ•›æ€§ã€‚</p>
</blockquote>
<h3 id="è®­ç»ƒè¿‡ç¨‹">è®­ç»ƒè¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#è®­ç»ƒè¿‡ç¨‹">#</a></h3>
<blockquote>
<p>â€‹	<code>torch.nn.utils.clip_grad_norm_</code> æ˜¯ä¸€ä¸ªç”¨äºæ¢¯åº¦è£å‰ªçš„å‡½æ•°ï¼Œå®ƒå¯ä»¥å¸®åŠ©é™åˆ¶æ¢¯åº¦çš„èŒƒæ•°ï¼Œé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸é—®é¢˜ã€‚<code>clip_grad_norm_</code> å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š<code>parameters</code> å’Œ <code>max_norm</code>ã€‚<code>parameters</code> æ˜¯æ¨¡å‹çš„å‚æ•°åˆ—è¡¨ï¼Œè€Œ <code>max_norm</code> æ˜¯ç”¨äºè£å‰ªæ¢¯åº¦çš„æœ€å¤§èŒƒæ•°å€¼ã€‚</p>
<p>â€‹	åœ¨ä»£ç ä¸­ï¼Œ<code>torch.nn.utils.clip_grad_norm_(model.parameters(), 1.)</code> è¡¨ç¤ºå¯¹æ¨¡å‹çš„æ‰€æœ‰å‚æ•°è¿›è¡Œæ¢¯åº¦è£å‰ªï¼Œå°†æ¢¯åº¦çš„èŒƒæ•°é™åˆ¶åœ¨ <code>1.0</code> å†…ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ¢¯åº¦ä¸ä¼šè¿‡å¤§ï¼Œé¿å…è®­ç»ƒè¿‡ç¨‹ä¸­çš„ä¸ç¨³å®šæ€§ã€‚</p>
<p>â€‹	æ¥ä¸‹æ¥ï¼Œ<code>optimizer.step()</code> æ˜¯ä¼˜åŒ–å™¨çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºæ›´æ–°æ¨¡å‹çš„å‚æ•°ã€‚å®ƒæ ¹æ®è®¡ç®—å¾—åˆ°çš„æ¢¯åº¦æ¥æ›´æ–°å‚æ•°ï¼Œä½¿æ¨¡å‹å‘æ›´å¥½çš„æ–¹å‘å‰è¿›ã€‚é€šè¿‡æ‰§è¡Œ <code>optimizer.step()</code>ï¼Œå¯ä»¥ä½¿æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¸æ–­ä¼˜åŒ–å’Œæ›´æ–°ã€‚</p>
</blockquote>
<h3 id="è®¤è¯†dataloader">è®¤è¯†dataloader<a hidden class="anchor" aria-hidden="true" href="#è®¤è¯†dataloader">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>dataloader <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>DataLoader(dataset,batch_size<span style="color:#f92672">=</span>batch_size,shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><blockquote>
<p>â€‹	<code>torch.utils.data.DataLoader</code> æ˜¯ PyTorch ä¸­ç”¨äºåŠ è½½æ•°æ®çš„å·¥å…·ç±»ã€‚åœ¨ç»™å®šæ•°æ®é›† <code>dataset</code> çš„æƒ…å†µä¸‹ï¼Œ<code>DataLoader</code> å¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»¥æŒ‡å®šçš„æ‰¹é‡å¤§å° <code>batch_size</code> åŠ è½½æ•°æ®ï¼Œå¹¶æä¾›ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œå¦‚æ•°æ®æ‰“ä¹±ï¼ˆé€šè¿‡è®¾ç½® <code>shuffle=True</code>ï¼‰å’Œå¹¶è¡ŒåŠ è½½æ•°æ®ã€‚</p>
<p>â€‹	å…·ä½“æ¥è¯´ï¼Œä¸Šè¿°ä»£ç åˆ›å»ºäº†ä¸€ä¸ª <code>DataLoader</code> å¯¹è±¡ <code>dataloader</code>ï¼Œå®ƒå°†æ•°æ®é›† <code>dataset</code> åˆ†æˆä»¥ <code>batch_size</code> ä¸ºå¤§å°çš„æ‰¹æ¬¡ã€‚è®¾ç½® <code>shuffle=True</code> è¡¨ç¤ºåœ¨æ¯ä¸ª epoch ä¸­å¯¹æ•°æ®è¿›è¡Œæ‰“ä¹±ï¼Œä»¥å¢åŠ æ•°æ®çš„éšæœºæ€§ã€‚</p>
<p>â€‹	é€šè¿‡ä½¿ç”¨ <code>dataloader</code>ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°è¿­ä»£éå†æ•°æ®é›†ï¼Œæ¯æ¬¡è¿­ä»£è·å¾—ä¸€ä¸ªæ‰¹æ¬¡çš„æ•°æ®ï¼Œæ–¹ä¾¿è¿›è¡Œè®­ç»ƒæˆ–æ¨æ–­æ“ä½œã€‚</p>
</blockquote>
<h2 id="å‚è€ƒ">å‚è€ƒ<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒ">#</a></h2>
<p><a href="https://lilianweng.github.io/posts/2021-07-11-diffusion-models/#:~:text=Diffusion%20models%20are%20inspired%20by%20non-equilibrium%20thermodynamics.%20They,to%20construct%20desired%20data%20samples%20from%20the%20noise.">[ä»€ä¹ˆæ˜¯æ‰©æ•£æ¨¡å‹ï¼Ÿ |åˆ©å°”æ—¥å¿— (lilianweng.github.io)](https://lilianweng.github.io/posts/2021-07-11-diffusion-models/#:~:text=Diffusion models are inspired by non-equilibrium thermodynamics. They,to construct desired data samples from the noise.)</a></p>
<p><a href="https://www.bilibili.com/video/BV1b541197HX/?spm_id_from=333.337.search-card.all.click&amp;vd_source=860dab0009d45f18b212f3b99520fa03">Probabilistic Diffusion Modelæ¦‚ç‡æ‰©æ•£æ¨¡å‹ç†è®ºä¸å®Œæ•´PyTorchä»£ç è¯¦ç»†è§£è¯»_å“”å“©å“”å“©_bilibili</a></p>
<p><a href="https://t.bilibili.com/700526762586538024?spm_id_from=333.999.0.0">deep_thoughtsçš„æ‰©æ•£æ¨¡å‹ç¬”è®° (bilibili.com)</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="answerboom.github.io/tags/%E6%89%A9%E6%95%A3%E6%A8%A1%E5%9E%8B/">æ‰©æ•£æ¨¡å‹</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="answerboom.github.io">ğŸ» liyBlog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0-rc.1/katex.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0-rc.1/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0-rc.1/contrib/auto-render.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
      renderMathInElement(document.body, {
              delimiters: [
                  {left: "$$", right: "$$", display: true},
                  {left: "$", right: "$", display: false}
              ]
          });
    });
</script>
</body>

</html>
